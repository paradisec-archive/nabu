#!/usr/bin/env bash

export AWS_OUTPUT="json"

TASK_NAME="${1}"
shift

echo "Getting cluster..."
CLUSTER=$(aws ecs list-clusters | jq -r '.clusterArns | .[]' | grep 'nabu$')

if [ -z "$TASK_NAME" ]; then
  TASKS=$(aws ecs list-services --cluster "$CLUSTER")

  echo "Please specify a task to run"
  echo Select from "$TASKS" | tr '' '\n'
  exit 1
fi

echo "Getting task def..."
TASK_DEF=$(aws ecs list-task-definitions | jq -r '.taskDefinitionArns | .[]' | grep -i "${TASK_NAME}Task" | tail -1)

# Build JSON array from arguments
CMD_JSON=$(printf '%s\n' "$@" | jq -R . | jq -s .)

aws ecs run-task \
  --cluster "$CLUSTER" \
  --task-definition "$TASK_DEF" \
  --launch-type EC2 \
  --overrides "{
    \"containerOverrides\": [{
      \"name\": \"$TASK_NAME\",
      \"command\": $CMD_JSON
    }]
  }"
